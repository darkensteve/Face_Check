<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Face Registration - FaceCheck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- Sidebar -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-chalkboard-teacher text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold">FaceCheck</h1>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="mt-6">
                <div class="px-3">
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Faculty Menu</div>
                </div>
                
                <a href="{{ url_for('faculty_dashboard') }}" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard
                </a>
                
                <a href="/manage_students" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-users mr-3"></i>
                    Manage Students
                </a>
                
                <a href="{{ url_for('faculty_my_classes') }}" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-chalkboard mr-3"></i>
                    My Classes
                </a>
                
                <a href="/attendance" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-camera mr-3"></i>
                    Take Attendance
                </a>
                
                <a href="/attendance_reports" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-chart-line mr-3"></i>
                    Reports and Analytics
                </a>
                
                <a href="/faculty/register_face" class="flex items-center px-6 py-3 bg-gray-700 text-white">
                    <i class="fas fa-user-plus mr-3"></i>
                    Register Face
                </a>
            </nav>
            
            <!-- User Info (Clickable to Profile) -->
            <div class="absolute bottom-0 w-64 border-t border-gray-700">
                <a href="{{ url_for('faculty_profile') }}" class="flex items-center px-6 py-3 hover:bg-gray-700 transition duration-200">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium">{{ session.username }}</div>
                        <div class="text-xs text-gray-400">Faculty</div>
                    </div>
                </a>
                <a href="{{ url_for('logout') }}" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Logout
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Faculty Face Registration</h2>
                            <p class="text-gray-600">Register your face for attendance system</p>
                        </div>
                        <a href="{{ url_for('faculty_dashboard') }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-4xl mx-auto">
                    <!-- Faculty Info -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-chalkboard-teacher mr-2"></i>Faculty Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Faculty Name</label>
                                <p class="mt-1 text-lg text-gray-900">{{ faculty_name }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Faculty ID</label>
                                <p class="mt-1 text-lg text-gray-900">{{ faculty_id }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-lg font-semibold text-blue-900 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Face Registration Instructions
                        </h3>
                        <ol class="list-decimal list-inside space-y-2 text-blue-800">
                            <li>Click "Start Camera" to begin face registration</li>
                            <li>Position your face in the center of the camera view</li>
                            <li>Ensure good lighting and clear visibility of your face</li>
                            <li>Look directly at the camera with a neutral expression</li>
                            <li>Click "Capture Face" when you're ready</li>
                            <li>Wait for confirmation that your face has been registered</li>
                        </ol>
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-yellow-800 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>Important:</strong> Make sure only your face is visible in the camera. 
                                The system will detect and validate your face before saving.
                            </p>
                        </div>
                    </div>

                    <!-- Camera Section -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 text-center">Face Registration</h3>
                        
                        <!-- Camera Controls -->
                        <div class="text-center mb-6">
                            <button id="startCamera" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 text-lg font-medium mr-4">
                                <i class="fas fa-camera mr-2"></i>Start Camera
                            </button>
                            <button id="stopCamera" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-200 text-lg font-medium" style="display: none;">
                                <i class="fas fa-stop mr-2"></i>Stop Camera
                            </button>
                        </div>

                        <!-- Camera Feed -->
                        <div id="cameraContainer" class="text-center mb-6" style="display: none;">
                            <div class="bg-gray-900 rounded-lg p-4 inline-block">
                                <video id="video" width="640" height="480" autoplay muted class="rounded-lg"></video>
                            </div>
                            <div id="status" class="mt-4 text-lg font-medium text-gray-700"></div>
                            
                            <!-- Capture Button -->
                            <div class="mt-4">
                                <button id="captureFace" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 text-lg font-medium">
                                    <i class="fas fa-camera mr-2"></i>Capture Face
                                </button>
                            </div>
                        </div>

                        <!-- Success Message -->
                        <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-green-800 font-medium">Face Registration Successful!</p>
                                    <p class="text-green-600 text-sm">Your face has been registered. You can now use the attendance system.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-red-800 font-medium">Registration Failed</p>
                                    <p class="text-red-600 text-sm">Please try again. Make sure your face is clearly visible.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let startBtn = document.getElementById('startCamera');
        let stopBtn = document.getElementById('stopCamera');
        let captureBtn = document.getElementById('captureFace');
        let cameraContainer = document.getElementById('cameraContainer');
        let status = document.getElementById('status');
        let successMessage = document.getElementById('successMessage');
        let errorMessage = document.getElementById('errorMessage');
        let isCapturing = false;

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480 
                    } 
                });
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                status.textContent = 'Camera started. Position your face in the center and look directly at the camera.';
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        });

        stopBtn.addEventListener('click', () => {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            cameraContainer.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            status.textContent = '';
        });

        captureBtn.addEventListener('click', async () => {
            if (isCapturing) return;
            isCapturing = true;
            
            status.textContent = 'Processing face registration...';
            captureBtn.disabled = true;
            
            try {
                // Create a canvas to capture the current frame
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                // Convert to blob and send to server
                canvas.toBlob(async (blob) => {
                    try {
                        const formData = new FormData();
                        formData.append('face_image', blob, 'face.jpg');
                        
                        const response = await fetch('/api/faculty/register_face', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            successMessage.classList.remove('hidden');
                            errorMessage.classList.add('hidden');
                            status.textContent = 'Face registered successfully! You can now use the attendance system.';
                            
                            // Stop camera after successful registration
                            setTimeout(() => {
                                if (video.srcObject) {
                                    video.srcObject.getTracks().forEach(track => track.stop());
                                }
                                cameraContainer.style.display = 'none';
                                startBtn.style.display = 'inline-block';
                                stopBtn.style.display = 'none';
                                
                                // Redirect to dashboard after 3 seconds
                                setTimeout(() => {
                                    window.location.href = '/faculty/dashboard';
                                }, 3000);
                            }, 2000);
                        } else {
                            errorMessage.classList.remove('hidden');
                            successMessage.classList.add('hidden');
                            status.textContent = result.error || 'Registration failed. Please try again.';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        errorMessage.classList.remove('hidden');
                        successMessage.classList.add('hidden');
                        status.textContent = 'Error occurred. Please try again.';
                    } finally {
                        isCapturing = false;
                        captureBtn.disabled = false;
                    }
                }, 'image/jpeg', 0.9);
            } catch (error) {
                console.error('Error:', error);
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                status.textContent = 'Error occurred. Please try again.';
                isCapturing = false;
                captureBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
